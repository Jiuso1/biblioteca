/*
 * This is sample code generated by rpcgen.
 * These are only templates and you can use them
 * as a guideline for developing your own functions.
 */

#include "GestorBiblioteca.h"
#include <unistd.h>
#include <stdio.h>

int menuPrincipal();
int menuAdministracion();
void esperarEntradaPorConsola();

void gestorbiblioteca_1(char *host)
{
	CLIENT *clnt;
	int *result_1;
	int conexion_1_arg;
	bool_t *result_2;
	int desconexion_1_arg;
	int *result_3;
	TConsulta cargardatos_1_arg;
	bool_t *result_4;
	int guardardatos_1_arg;
	int *result_5;
	TNuevo nuevolibro_1_arg;
	int *result_6;
	TComRet comprar_1_arg;
	int *result_7;
	TComRet retirar_1_arg;
	bool_t *result_8;
	TOrdenacion ordenar_1_arg;
	int *result_9;
	int nlibros_1_arg;
	int *result_10;
	TConsulta buscar_1_arg;
	TLibro *result_11;
	TPosicion descargar_1_arg;
	int *result_12;
	TPosicion prestar_1_arg;
	int *result_13;
	TPosicion devolver_1_arg;

#ifndef DEBUG
	clnt = clnt_create(host, GESTORBIBLIOTECA, GESTORBIBLIOTECA_VER, "udp");
	if (clnt == NULL)
	{
		clnt_pcreateerror(host);
		exit(1);
	}
#endif /* DEBUG */
	int opcionElegida = menuPrincipal();
	int contrasenha = 0;
	int idAdministrador = 0;
	Cadena nombreFichero = "";
	int NumLibros = 0;
	TLibro libro = {}; // Los struct se inicializan así.
	Cadena isbn = "";
	Cadena autor = "";
	Cadena titulo = "";
	int anio = 0;
	Cadena pais = "";
	Cadena idioma = "";
	TNuevo nuevoLibro = {};

	switch (opcionElegida)
	{
	case 1:
	{
		printf("Por favor inserte la contraseña de Administracion:\n");
		scanf("%d", &contrasenha);
		conexion_1_arg = contrasenha;
		result_1 = conexion_1(&conexion_1_arg, clnt);
		if (result_1 == (int *)NULL)
		{
			clnt_perror(clnt, "call failed");
		}
		else if (*result_1 == -2)
		{
			printf("ERROR: la contrasenha introducida es incorrecta\n");
		}
		else if (*result_1 == -1)
		{
			printf("ERROR: ya hay un administrador logueado\n");
		}
		else
		{
			idAdministrador = *result_1; // Guardamos el id generado por el servidor en el cliente administrador.
			printf("*** Contraseña correcta, puede acceder al menu de Administracion.**\n");
			esperarEntradaPorConsola(); // Esperamos a que el usuario pulse cualquier tecla.
			do
			{
				opcionElegida = menuAdministracion();
				switch (opcionElegida)
				{
				case 0:
				{
					desconexion_1_arg = idAdministrador;
					result_2 = desconexion_1(&desconexion_1_arg, clnt);
					if (result_2 == (bool_t *)NULL)
					{
						clnt_perror(clnt, "call failed");
					}
					else if (*result_2 == FALSE)
					{
						printf("ERROR: el id administrador no coincide con el del servidor\n");
					}
					else if (*result_2 == TRUE)
					{
						printf("Ha cerrado sesion con exito\n");
					}
					break;
				}
				case 1:
				{
					printf("Introduce el nombre del fichero de datos:\n");
					scanf("%s", nombreFichero);
					strcpy(cargardatos_1_arg.Datos, nombreFichero);
					cargardatos_1_arg.Ida = idAdministrador;
					result_3 = cargardatos_1(&cargardatos_1_arg, clnt);
					if (result_3 == (int *)NULL)
					{
						clnt_perror(clnt, "call failed");
					}
					else if (*result_3 == -1)
					{
						printf("ERROR: ya hay un administrador logueado\n");
					}
					else if (*result_3 == 0)
					{
						printf("ERROR: error al cargar los datos\n");
					}
					else if (*result_3 == 1)
					{
						printf("Datos cargados y ordenados correctamente\n");
					}
					esperarEntradaPorConsola(); // Esperamos a que el usuario pulse cualquier tecla.
					break;
				}
				case 3:
				{
					// Pedimos los datos del nuevo libro:

					printf("Introduce el Isbn:\n");
					scanf("%s", isbn);
					printf("Introduce el Autor:\n");
					scanf("%s", autor);
					printf("Introduce el Titulo:\n");
					scanf("%s", titulo);
					printf("Introduce el anio:\n");
					scanf("%d", &anio);
					printf("Introduce el Pais:\n");
					scanf("%s", pais);
					printf("Introduce el Idioma:\n");
					scanf("%s", idioma);

					// Llenamos la variable libro:
					strcpy(libro.Isbn, isbn);
					strcpy(libro.Autor, autor);
					strcpy(libro.Titulo, titulo);
					libro.Anio = anio;
					strcpy(libro.Pais, pais);
					strcpy(libro.Idioma, idioma);

					// Inicializamos los valores no pedidos por consola:
					libro.NoLibros = 0;
					libro.NoListaEspera = 0;
					libro.NoPrestados = 0;

					nuevoLibro.Libro = libro;	   // Guardamos libro en el campo de nuevoLibro.
					nuevolibro_1_arg = nuevoLibro; // Lo pasamos por argumento.
					result_5 = nuevolibro_1(&nuevolibro_1_arg, clnt);
					if (result_5 == (int *)NULL)
					{
						clnt_perror(clnt, "call failed");
					}
					else if (*result_5 == -1)
					{
						printf("ERROR: ya hay un administrador logueado\n");
					}
					else if (*result_5 == 0)
					{
						printf("ERROR: ya hay un libro registrado con el ISBN dado\n");
					}
					else if (*result_5 == 1)
					{
						printf("Se ha anhadido el nuevo libro correctamente\n");
					}
					break;
				}
				case 8:
				{
					// Recogemos del servidor el numero de libros:
					nlibros_1_arg = idAdministrador; // Le pasamos al servidor el id de administrador.
					result_9 = nlibros_1(&nlibros_1_arg, clnt);
					if (result_9 == (int *)NULL)
					{
						clnt_perror(clnt, "call failed");
					}
					else
					{
						// Ya formatearemos guay la práctica y le meteremos musiquita, ahora nos debemos centrar en que funcione simplemente.
						printf("POS\tTITULO\tISBN\tDIS\tPRE\tPOS\n");
						printf("\tAUTOR\tPAIS (IDIOMA)\tANIO\n");
						printf("*********************************************************************************************\n");

						NumLibros = *result_9; // Guardamos el resultado en la variable del cliente.

						descargar_1_arg.Ida = idAdministrador; // Le pasamos al servidor nuestro id.

						// Descargamos cada libro del servidor y lo mostramos por pantalla:
						for (int i = 0; i < NumLibros; i++)
						{
							descargar_1_arg.Pos = i;						 // Iteramos usando descargar_1_arg e i.
							result_11 = descargar_1(&descargar_1_arg, clnt); // Descarga el libro i.
							if (result_11 == (TLibro *)NULL)
							{
								clnt_perror(clnt, "call failed");
							}
							else
							{
								// Hemos recibido el resultado bien, podemos guardarlo en libro y escribir por pantalla.
								libro = *result_11;
								printf("%d\t%s\t%s\t%d\t%d\t%d\n", i, libro.Titulo, libro.Isbn, libro.NoLibros, libro.NoPrestados, libro.NoListaEspera);
								printf("%s\t%s(%s)\t%d\n", libro.Autor, libro.Pais, libro.Idioma, libro.Anio);
							}
						}
						esperarEntradaPorConsola(); // Esperamos a que el usuario pulse cualquier tecla.
					}
					break;
				}
				}
			} while (opcionElegida != 0);
		}
		break;
	}
	}
#ifndef DEBUG
	clnt_destroy(clnt);
#endif /* DEBUG */
}

int main(int argc, char *argv[])
{
	char *host;

	if (argc < 2)
	{
		printf("usage: %s server_host\n", argv[0]);
		exit(1);
	}
	host = argv[1];
	gestorbiblioteca_1(host);
	exit(0);
}
int menuPrincipal()
{
	int opcionElegida = 0;
	do
	{
		system("clear");
		printf("GESTOR BIBLIOTECARIO 1.0 (M. PRINCIPAL)\n");
		printf("***************************************\n");
		printf("\t1.- M. Administración\n");
		printf("\t2.- Consulta de libros\n");
		printf("\t3.- Préstamo de libros\n");
		printf("\t4.- Devolución de libros\n");
		printf("\t0.- Salir\n");
		printf("\n");
		printf("  Elige opción:\n");
		scanf("%d", &opcionElegida);
	} while (opcionElegida < 0 || opcionElegida > 4);
	return opcionElegida;
}

int menuAdministracion()
{
	int opcionElegida = 0;
	do
	{
		system("clear");
		printf("GESTOR BIBLIOTECARIO 1.0 (M. ADMINISTRACION)\n");
		printf("********************************************\n");
		printf("\t1.- Cargar datos Biblioteca\n");
		printf("\t2.- Guardar datos Biblioteca\n");
		printf("\t3.- Nuevo libro\n");
		printf("\t4.- Comprar libros\n");
		printf("\t5.- Retirar libros\n");
		printf("\t6.- Ordenar libros\n");
		printf("\t6.- Ordenar libros\n");
		printf("\t7.- Buscar libros\n");
		printf("\t8.- Listar libros\n");
		printf("\t0.- Salir\n");
		printf("  Elige opción:\n");
		scanf("%d", &opcionElegida);
	} while (opcionElegida < 0 || opcionElegida > 8);
	return opcionElegida;
}

void esperarEntradaPorConsola()
{
	printf("Introduzca cualquier numero para continuar.....\n");
	int noImporta = 0;
	scanf("%d", &noImporta);
}